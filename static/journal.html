<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trading Journal - MarketDashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg-1:#0b1220;
        --bg-2:#0f1b2b;
        --ink:#e6edf5;
        --muted:#9fb2c7;
        --accent:#3ddc97;
        --accent-2:#ffb454;
        --danger:#ff6b6b;
        --card:#0f1e2f;
        --stroke:#1c2b3a;
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family:"IBM Plex Sans",sans-serif;
        color:var(--ink);
        background: linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height:100vh;
      }
      .wrap{ max-width:1200px; margin:0 auto; padding:40px 24px; }
      .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; }
      .title{ font-family:"Space Grotesk"; font-size:32px; font-weight:700; margin:0; }
      .btn-back{ color:var(--muted); text-decoration:none; border:1px solid var(--stroke); padding:8px 16px; border-radius:10px; font-size:14px; }
      .btn-back:hover{ color:var(--ink); border-color:var(--ink); }

      /* Stats Grid */
      .stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:40px; }
      .stat-card{ background:var(--card); border:1px solid var(--stroke); padding:24px; border-radius:15px; }
      .stat-val{ display:block; font-size:28px; font-weight:700; font-family:"Space Grotesk"; margin-bottom:5px; }
      .stat-label{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:1px; }

      /* Monthly Table */
      .section-title{ font-family:"Space Grotesk"; font-size:20px; color:var(--accent); margin-bottom:20px; display:flex; align-items:center; gap:10px; }
      .monthly-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:15px; margin-bottom:40px; }
      .month-card{ background:rgba(255,255,255,0.03); border:1px solid var(--stroke); padding:15px; border-radius:10px; text-align:center; }
      .month-name{ display:block; font-weight:700; margin-bottom:5px; color:var(--muted); }
      .month-pnl{ font-weight:700; font-size:16px; }

      /* Trades Table */
      table { width: 100%; border-collapse: collapse; font-size: 13px; background:var(--card); border-radius:12px; overflow:hidden; border:1px solid var(--stroke); }
      th { text-align: left; padding: 12px 16px; color: var(--muted); font-weight: 600; border-bottom: 1px solid var(--stroke); text-transform: uppercase; font-size: 11px; }
      td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.03); }
      tr:hover td { background: rgba(255,255,255,0.02); }

      .val-up{ color:var(--accent); }
      .val-down{ color:var(--danger); }
      .ticker{ font-weight:700; color:var(--accent); }
      .date-small{ color:var(--muted); font-size:11px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <h1 class="title">Trading Journal</h1>
        <a href="index.html" class="btn-back">‚Üê Back to Dashboard</a>
      </div>

      <div class="stats-grid" id="statsContainer">
        <!-- Stats here -->
      </div>

      <h2 class="section-title">üìÖ Monthly Performance</h2>
      <div class="monthly-grid" id="monthlyContainer">
        <!-- Monthly cards here -->
      </div>

      <h2 class="section-title">üìë Closed Trades (FIFO)</h2>
      <div id="tradesContainer">
        <div style="padding:40px; text-align:center; color:var(--muted)">Analyzing performance...</div>
      </div>
    </div>

    <script>
      async function loadJournal() {
        try {
          const resp = await fetch('/api/v2/portfolio/performance');
          const data = await resp.json();
          renderStats(data.stats);
          renderMonthly(data.monthly);
          renderTrades(data.closed_trades);
        } catch (err) {
          console.error(err);
        }
      }

      function renderStats(stats) {
        if(!stats) return;
        const container = document.getElementById('statsContainer');
        const items = [
          { label: 'Realized P&L', val: `$${stats.total_realized_pnl.toLocaleString()}`, cls: stats.total_realized_pnl >= 0 ? 'val-up' : 'val-down' },
          { label: 'Win Rate', val: `${stats.win_rate.toFixed(1)}%`, cls: 'val-up' },
          { label: 'Avg P&L %', val: `${stats.avg_pnl_pct.toFixed(2)}%`, cls: stats.avg_pnl_pct >= 0 ? 'val-up' : 'val-down' },
          { label: 'Avg Annualized (CAGR)', val: `${stats.avg_annualized.toFixed(1)}%`, cls: stats.avg_annualized >= 0 ? 'val-up' : 'val-down' },
          { label: 'Total Trades', val: stats.total_trades, cls: '' },
          { label: 'Avg Duration', val: `${stats.avg_duration.toFixed(1)} days`, cls: '' }
        ];
        container.innerHTML = items.map(i => `
          <div class="stat-card">
            <span class="stat-val ${i.cls}">${i.val}</span>
            <span class="stat-label">${i.label}</span>
          </div>
        `).join('');
      }

      function renderMonthly(monthly) {
        if(!monthly) return;
        const container = document.getElementById('monthlyContainer');
        const sortedMonths = Object.keys(monthly).sort().reverse();
        
        container.innerHTML = sortedMonths.map(m => {
          const d = monthly[m];
          const cls = d.pnl >= 0 ? 'val-up' : 'val-down';
          return `
            <div class="month-card">
              <span class="month-name">${m}</span>
              <span class="month-pnl ${cls}">${d.pnl >= 0 ? '+' : ''}$${d.pnl.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
              <div style="font-size:10px; color:var(--muted); margin-top:5px;">${d.wins}/${d.trades} Wins</div>
            </div>
          `;
        }).join('');
      }

      function renderTrades(trades) {
        const container = document.getElementById('tradesContainer');
        if(!trades || !trades.length) {
          container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--muted)">No closed trades found in history.</div>';
          return;
        }

        let html = `<table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Qty</th>
              <th>Buy Date</th>
              <th>Sell Date</th>
              <th>Buy Price</th>
              <th>Sell Price</th>
              <th>Duration</th>
              <th>P&L %</th>
              <th>P&L $</th>
            </tr>
          </thead>
          <tbody>`;
        
        trades.forEach(t => {
          const cls = t.pnl_val >= 0 ? 'val-up' : 'val-down';
          html += `
            <tr>
              <td><span class="ticker">${t.ticker}</span></td>
              <td>${t.qty}</td>
              <td class="date-small">${t.open_date.split('T')[0]}</td>
              <td class="date-small">${t.close_date.split('T')[0]}</td>
              <td>$${t.buy_price.toFixed(2)}</td>
              <td>$${t.sell_price.toFixed(2)}</td>
              <td>${t.duration_days}d</td>
              <td class="${cls}" style="font-weight:600">${t.pnl_pct >= 0 ? '+' : ''}${t.pnl_pct.toFixed(2)}%</td>
              <td class="${cls}" style="font-weight:700">${t.pnl_val >= 0 ? '+' : ''}$${t.pnl_val.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            </tr>
          `;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      loadJournal();
    </script>
  </body>
</html>
