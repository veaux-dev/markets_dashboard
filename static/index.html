<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Market Screener V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg-1:#0b1220;
        --bg-2:#0f1b2b;
        --ink:#e6edf5;
        --muted:#9fb2c7;
        --accent:#3ddc97;
        --accent-2:#ffb454;
        --danger:#ff6b6b;
        --card:#0f1e2f;
        --stroke:#1c2b3a;
        --panel:rgba(255,255,255,0.03);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family:"IBM Plex Sans",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
        color:var(--ink);
        background:
          radial-gradient(900px 420px at 10% -10%, #1c3a52 0%, rgba(28,58,82,0) 60%),
          radial-gradient(700px 420px at 90% 0%, #17303f 0%, rgba(23,48,63,0) 60%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height:100vh;
      }
      .wrap{
        max-width:1200px;
        margin:0 auto;
        padding:40px 24px 80px;
      }
      .hero{
        margin-bottom:40px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .actions{
        display:flex;
        gap:10px;
        align-items:center;
      }
      .ticker-input{
        padding:8px 12px;
        border-radius:10px;
        border:1px solid var(--stroke);
        background:#0b1724;
        color:var(--ink);
        font-size:14px;
        width: 120px;
      }
      .btn-load{
        color:var(--ink);
        text-decoration:none;
        border:1px solid var(--stroke);
        padding:8px 14px;
        border-radius:10px;
        font-size:14px;
        background:rgba(255,255,255,0.03);
        cursor: pointer;
      }
      .btn-load:hover{ background: rgba(255,255,255,0.08); }
      .title{
        font-family:"Space Grotesk",sans-serif;
        font-size:38px;
        font-weight:700;
        margin:0;
      }
      .subtitle{
        color:var(--muted);
        margin-top:8px;
        font-size:16px;
      }
      .grid{
        display:grid;
        grid-template-columns:1fr;
        gap:20px;
      }
      .card{
        background:var(--card);
        border:1px solid var(--stroke);
        border-radius:16px;
        padding:20px;
        transition:transform 0.2s ease, border-color 0.2s ease;
        text-decoration:none;
        color:inherit;
        display:grid;
        grid-template-columns: 120px 2fr 1fr 1fr 1fr 100px;
        align-items:center;
        gap:16px;
      }
      .card:hover{
        border-color:var(--accent);
        transform:translateX(4px);
        background:rgba(255,255,255,0.05);
      }
      .ticker-box{
        font-family:"Space Grotesk",sans-serif;
        font-size:22px;
        font-weight:700;
        color:var(--accent);
      }
      .name-box{
        display:flex;
        flex-direction:column;
      }
      .name-box .name{ font-weight:500; font-size:15px; }
      .name-box .reason{ color:var(--muted); font-size:12px; margin-top:4px; }
      
      .metric{
        display:flex;
        flex-direction:column;
      }
      .metric .label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.5px; }
      .metric .value{ font-weight:600; font-size:16px; margin-top:4px; }
      
      .val-up{ color:var(--accent); }
      .val-down{ color:var(--danger); }
      .val-neutral{ color:var(--muted); }

      .badge-strat{
        padding:4px 8px;
        border-radius:6px;
        font-size:11px;
        font-weight:700;
        background:rgba(255,255,255,0.05);
        border:1px solid var(--stroke);
        display:inline-block;
      }
      
      .loading{
        text-align:center;
        padding:100px;
        color:var(--muted);
        font-size:18px;
      }
      
      .header-row{
        display:grid;
        grid-template-columns: 120px 2fr 1fr 1fr 1fr 100px;
        gap:16px;
        padding:0 20px 10px;
        color:var(--muted);
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:1px;
        border-bottom:1px solid var(--stroke);
        margin-bottom:10px;
      }

      @media (max-width:900px){
        .header-row{ display:none; }
        .card{
            grid-template-columns: 1fr 1fr;
            gap:12px;
        }
        .ticker-box{ grid-column: span 2; }
        .name-box{ grid-column: span 2; margin-bottom:10px; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1 class="title">Market Screener</h1>
          <p class="subtitle">Dynamic Watchlist (Broad Scan candidates)</p>
        </div>
        <div class="actions">
          <div id="statusPill" class="badge-strat" style="margin-right:10px">Syncing...</div>
          <div style="display:flex; gap:8px; margin-right:20px; border-right:1px solid var(--stroke); padding-right:20px;">
            <button class="btn-load" id="btnRefreshList" title="Re-run strategies on existing data">↻ Refresh List</button>
            <button class="btn-load" id="btnRecalc" title="Recalculate indicators (Slow)" style="border-color:var(--stroke); color:var(--muted)">⚠ Recalc DB</button>
          </div>
          <input class="ticker-input" id="manualTicker" placeholder="Ticker (e.g. AAPL)">
          <button class="btn-load" id="btnGo">Go to Deep View</button>
        </div>
      </div>

      <div class="header-row">
        <div>Ticker</div>
        <div>Company / Reason</div>
        <div>Price / Chg</div>
        <div>RSI (1d)</div>
        <div>ADX (1d)</div>
        <div>Vol K</div>
      </div>

      <div class="grid" id="screenerGrid">
        <div class="loading">Fetching candidates from DuckDB...</div>
      </div>
    </div>

    <script>
      const grid = document.getElementById("screenerGrid");
      const statusPill = document.getElementById("statusPill");
      const manualTicker = document.getElementById("manualTicker");
      const btnGo = document.getElementById("btnGo");
      const btnRefreshList = document.getElementById("btnRefreshList");
      const btnRecalc = document.getElementById("btnRecalc");

      btnGo.onclick = () => {
        const t = manualTicker.value.trim().toUpperCase();
        if (t) window.location.href = `triple_screen.html?ticker=${t}`;
      };
      manualTicker.onkeydown = (e) => { if (e.key === 'Enter') btnGo.click(); };

      btnRefreshList.onclick = async () => {
        if(confirm("Refresh dynamic watchlist from existing DB data?")) {
            statusPill.textContent = "Running...";
            try {
                await fetch('/api/v2/system/refresh-watchlist', {method:'POST'});
                setTimeout(loadScreener, 2000); // Give it a sec
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      btnRecalc.onclick = async () => {
        if(confirm("⚠ WARNING: This will recalculate indicators for ALL tickers. It may take minutes.\n\nContinue?")) {
            statusPill.textContent = "Recalculating...";
            try {
                await fetch('/api/v2/system/recalc-indicators', {method:'POST'});
                alert("Recalculation started in background. Check logs or refresh later.");
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      async function loadScreener(){
        try {
          const resp = await fetch('/api/v2/screener');
          if (!resp.ok) throw new Error("API Error");
          const data = await resp.json();
          
          if (data.length === 0) {
            grid.innerHTML = '<div class="loading">No candidates found in dynamic_watchlist. Check if Broad Scan has run.</div>';
            statusPill.textContent = "Empty";
            return;
          }

          renderScreener(data);
          statusPill.textContent = `Active: ${data.length}`;
        } catch (err) {
          grid.innerHTML = `<div class="loading">Error connecting to API: ${err.message}</div>`;
          statusPill.textContent = "Offline";
        }
      }

      function renderScreener(items){
        grid.innerHTML = "";
        items.forEach(item => {
          const chg = item.chg_pct || 0;
          const chgClass = chg >= 0 ? 'val-up' : 'val-down';
          const rsiVal = item.rsi ? item.rsi.toFixed(1) : '—';
          const adxVal = item.adx ? item.adx.toFixed(1) : '—';
          const volVal = item.vol_k ? `x${item.vol_k.toFixed(2)}` : '—';
          
          const card = document.createElement("a");
          card.className = "card";
          card.href = `triple_screen.html?ticker=${item.ticker}`;
          
          card.innerHTML = `
            <div class="ticker-box">${item.ticker}</div>
            <div class="name-box">
                <span class="name">${item.name || item.ticker}</span>
                <span class="reason"><span class="badge-strat">${item.reason}</span> Added: ${item.added_at.split(' ')[0]}</span>
            </div>
            <div class="metric">
                <span class="label">Price</span>
                <span class="value">${item.close ? item.close.toFixed(2) : '—'} <span class="${chgClass}" style="font-size:12px">${chg >= 0 ? '+' : ''}${chg.toFixed(1)}%</span></span>
            </div>
            <div class="metric">
                <span class="label">RSI (14)</span>
                <span class="value ${getRsiClass(item.rsi)}">${rsiVal}</span>
            </div>
            <div class="metric">
                <span class="label">ADX</span>
                <span class="value ${item.adx > 25 ? 'val-up' : ''}">${adxVal}</span>
            </div>
            <div class="metric">
                <span class="label">Volume</span>
                <span class="value ${item.vol_k > 1.5 ? 'val-up' : ''}">${volVal}</span>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      function getRsiClass(val){
        if (!val) return '';
        if (val >= 70) return 'val-down';
        if (val <= 30) return 'val-up';
        return '';
      }

      loadScreener();
      // Refresh cada 5 minutos
      setInterval(loadScreener, 300000);
    </script>
  </body>
</html>