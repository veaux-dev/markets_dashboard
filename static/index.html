<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Market Screener V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg-1:#0b1220;
        --bg-2:#0f1b2b;
        --ink:#e6edf5;
        --muted:#9fb2c7;
        --accent:#3ddc97;
        --accent-2:#ffb454;
        --danger:#ff6b6b;
        --card:#0f1e2f;
        --stroke:#1c2b3a;
        --panel:rgba(255,255,255,0.03);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family:"IBM Plex Sans",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
        color:var(--ink);
        background:
          radial-gradient(900px 420px at 10% -10%, #1c3a52 0%, rgba(28,58,82,0) 60%),
          radial-gradient(700px 420px at 90% 0%, #17303f 0%, rgba(23,48,63,0) 60%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height:100vh;
      }
      .wrap{
        max-width:1200px;
        margin:0 auto;
        padding:40px 24px 80px;
      }
      .hero{
        margin-bottom:40px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .actions{
        display:flex;
        gap:10px;
        align-items:center;
      }
      .ticker-input{
        padding:8px 12px;
        border-radius:10px;
        border:1px solid var(--stroke);
        background:#0b1724;
        color:var(--ink);
        font-size:14px;
        width: 120px;
      }
      .btn-load{
        color:var(--ink);
        text-decoration:none;
        border:1px solid var(--stroke);
        padding:8px 14px;
        border-radius:10px;
        font-size:14px;
        background:rgba(255,255,255,0.03);
        cursor: pointer;
      }
      .btn-load:hover{ background: rgba(255,255,255,0.08); }
      .title{
        font-family:"Space Grotesk",sans-serif;
        font-size:38px;
        font-weight:700;
        margin:0;
      }
      .subtitle{
        color:var(--muted);
        margin-top:8px;
        font-size:16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
      }
      th {
        text-align: left;
        padding: 12px 16px;
        color: var(--muted);
        font-weight: 600;
        border-bottom: 1px solid var(--stroke);
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
      }
      td {
        padding: 10px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.03);
        vertical-align: middle;
      }
      tr:hover td {
        background: rgba(255,255,255,0.02);
      }
      .ticker-cell {
        font-family: "Space Grotesk", sans-serif;
        font-weight: 700;
        color: var(--accent);
        font-size: 15px;
      }
      .name-cell {
        color: var(--ink);
        font-weight: 500;
      }
      .meta-cell {
        font-size: 12px;
        color: var(--muted);
      }
      .row-link {
        text-decoration: none;
        color: inherit;
        display: contents; /* Trick to make <a> wrap tr behavior? No, better click handler or <a> inside td */
      }
      /* Clickable row technique */
      tr { cursor: pointer; }

      .val-up{ color:var(--accent); }
      .val-down{ color:var(--danger); }
      .val-neutral{ color:var(--muted); }

      .badge-strat{
        padding:3px 8px;
        border-radius:4px;
        font-size:10px;
        font-weight:700;
        background:rgba(255,255,255,0.05);
        border:1px solid var(--stroke);
        display:inline-block;
        margin-right: 6px;
      }
      
      @media (max-width: 700px) {
        .hide-mobile { display: none; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1 class="title">Market Screener</h1>
          <p class="subtitle">Dynamic Watchlist (Broad Scan candidates)</p>
        </div>
        <div class="actions">
          <div id="statusPill" class="badge-strat" style="margin-right:10px">Syncing...</div>
          <div style="display:flex; gap:8px; margin-right:20px; border-right:1px solid var(--stroke); padding-right:20px;">
            <button class="btn-load" id="btnRefreshList" title="Re-run strategies on existing data">↻ Refresh</button>
            <button class="btn-load" id="btnRecalc" title="Recalculate indicators (Slow)" style="border-color:var(--stroke); color:var(--muted)">⚠ Recalc</button>
          </div>
          <input class="ticker-input" id="manualTicker" placeholder="Ticker (e.g. AAPL)">
          <button class="btn-load" id="btnGo">Go</button>
        </div>
      </div>

      <div id="tableContainer">
        <div class="loading">Fetching candidates...</div>
      </div>
    </div>

    <script>
      const tableContainer = document.getElementById("tableContainer");
      const statusPill = document.getElementById("statusPill");
      const manualTicker = document.getElementById("manualTicker");
      const btnGo = document.getElementById("btnGo");
      const btnRefreshList = document.getElementById("btnRefreshList");
      const btnRecalc = document.getElementById("btnRecalc");

      btnGo.onclick = () => {
        const t = manualTicker.value.trim().toUpperCase();
        if (t) window.location.href = `triple_screen.html?ticker=${t}`;
      };
      manualTicker.onkeydown = (e) => { if (e.key === 'Enter') btnGo.click(); };

      btnRefreshList.onclick = async () => {
        if(confirm("Refresh dynamic watchlist from existing DB data?")) {
            statusPill.textContent = "Running...";
            try {
                await fetch('/api/v2/system/refresh-watchlist', {method:'POST'});
                setTimeout(loadScreener, 2000); // Give it a sec
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      btnRecalc.onclick = async () => {
        if(confirm("⚠ WARNING: This will recalculate indicators for ALL tickers. It may take minutes.\n\nContinue?")) {
            statusPill.textContent = "Recalculating...";
            try {
                await fetch('/api/v2/system/recalc-indicators', {method:'POST'});
                alert("Recalculation started in background. Check logs or refresh later.");
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      async function loadScreener(){
        try {
          const resp = await fetch('/api/v2/screener');
          if (!resp.ok) throw new Error("API Error");
          const data = await resp.json();
          renderScreener(data);
          statusPill.textContent = `Active: ${data.length}`;
        } catch (err) {
          tableContainer.innerHTML = `<div class="loading">Error connecting to API: ${err.message}</div>`;
          statusPill.textContent = "Offline";
        }
      }

      function renderScreener(items){
        if(!items.length) {
            tableContainer.innerHTML = '<div class="loading">No candidates found.</div>';
            return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Strategy / Reason</th>
                <th>Price</th>
                <th>Chg (1D)</th>
                <th>RSI</th>
                <th class="hide-mobile">ADX</th>
                <th class="hide-mobile">Vol K</th>
                <th class="hide-mobile">Added</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        items.forEach(item => {
          const chg = item.chg_pct || 0;
          const chgClass = chg >= 0 ? 'val-up' : 'val-down';
          const rsiVal = item.rsi != null ? item.rsi.toFixed(1) : '—';
          const adxVal = item.adx != null ? item.adx.toFixed(1) : '—';
          const volVal = item.vol_k != null ? `x${item.vol_k.toFixed(2)}` : '—';
          const priceVal = item.close != null ? item.close.toFixed(2) : '—';
          const dateAdded = item.added_at ? item.added_at.split(' ')[0] : '';
          
          html += `
            <tr onclick="window.location.href='triple_screen.html?ticker=${item.ticker}'">
              <td class="ticker-cell">${item.ticker}</td>
              <td>
                <span class="badge-strat">${item.reason}</span>
                <span class="meta-cell">${item.name || ''}</span>
              </td>
              <td style="font-weight:600">${priceVal}</td>
              <td class="${chgClass}">${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%</td>
              <td class="${getRsiClass(item.rsi)}">${rsiVal}</td>
              <td class="hide-mobile ${item.adx > 25 ? 'val-up' : 'val-neutral'}">${adxVal}</td>
              <td class="hide-mobile ${item.vol_k > 1.5 ? 'val-up' : 'val-neutral'}">${volVal}</td>
              <td class="meta-cell hide-mobile">${dateAdded}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table>`;
        tableContainer.innerHTML = html;
      }


      function getRsiClass(val){
        if (!val) return '';
        if (val >= 70) return 'val-down';
        if (val <= 30) return 'val-up';
        return '';
      }

      loadScreener();
      // Refresh cada 5 minutos
      setInterval(loadScreener, 300000);
    </script>
  </body>
</html>