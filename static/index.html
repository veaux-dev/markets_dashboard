<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Market Screener V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg-1:#0b1220;
        --bg-2:#0f1b2b;
        --ink:#e6edf5;
        --muted:#9fb2c7;
        --accent:#3ddc97;
        --accent-2:#ffb454;
        --danger:#ff6b6b;
        --card:#0f1e2f;
        --stroke:#1c2b3a;
        --panel:rgba(255,255,255,0.03);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family:"IBM Plex Sans",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
        color:var(--ink);
        background:
          radial-gradient(900px 420px at 10% -10%, #1c3a52 0%, rgba(28,58,82,0) 60%),
          radial-gradient(700px 420px at 90% 0%, #17303f 0%, rgba(23,48,63,0) 60%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height:100vh;
      }
      .wrap{
        max-width:1200px;
        margin:0 auto;
        padding:40px 24px 80px;
      }
      .hero{
        margin-bottom:40px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .actions{
        display:flex;
        gap:10px;
        align-items:center;
      }
      .ticker-input{
        padding:8px 12px;
        border-radius:10px;
        border:1px solid var(--stroke);
        background:#0b1724;
        color:var(--ink);
        font-size:14px;
        width: 120px;
      }
      .btn-load{
        color:var(--ink);
        text-decoration:none;
        border:1px solid var(--stroke);
        padding:8px 14px;
        border-radius:10px;
        font-size:14px;
        background:rgba(255,255,255,0.03);
        cursor: pointer;
      }
      .btn-load:hover{ background: rgba(255,255,255,0.08); }
      .title{
        font-family:"Space Grotesk",sans-serif;
        font-size:38px;
        font-weight:700;
        margin:0;
      }
      .subtitle{
        color:var(--muted);
        margin-top:8px;
        font-size:16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
      }
      th {
        text-align: left;
        padding: 12px 16px;
        color: var(--muted);
        font-weight: 600;
        border-bottom: 1px solid var(--stroke);
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
      }
      td {
        padding: 10px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.03);
        vertical-align: middle;
      }
      tr:hover td {
        background: rgba(255,255,255,0.02);
      }
      tr.is-holding {
        background: rgba(61, 220, 151, 0.03);
      }
      tr.is-holding td:first-child {
        border-left: 3px solid var(--accent);
      }
      th.sortable {
        cursor: pointer;
        user-select: none;
      }
      th.sortable:hover {
        color: var(--accent);
      }
      th.sortable:after {
        content: ' ‚Üï';
        font-size: 9px;
        opacity: 0.5;
      }
      .ticker-cell {
        font-family: "Space Grotesk", sans-serif;
        font-weight: 700;
        color: var(--accent);
        font-size: 15px;
      }
      .glossary {
        margin-top: 40px;
        padding: 20px;
        background: var(--card);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .glossary-item h4 {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--accent);
        text-transform: uppercase;
      }
      .glossary-item p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }
      .val-up{ color:var(--accent); }
      .name-cell {
        color: var(--ink);
        font-weight: 500;
      }
      .meta-cell {
        font-size: 12px;
        color: var(--muted);
      }
      .row-link {
        text-decoration: none;
        color: inherit;
        display: contents; /* Trick to make <a> wrap tr behavior? No, better click handler or <a> inside td */
      }
      /* Clickable row technique */
      tr { cursor: pointer; }

      .val-up{ color:var(--accent); }
      .val-down{ color:var(--danger); }
      .val-neutral{ color:var(--muted); }

      .badge-strat{
        padding:3px 8px;
        border-radius:4px;
        font-size:10px;
        font-weight:700;
        background:rgba(255,255,255,0.05);
        border:1px solid var(--stroke);
        display:inline-block;
        margin-right: 6px;
      }
      
      @media (max-width: 700px) {
        .hide-mobile { display: none; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1 class="title">Market Screener</h1>
          <p class="subtitle">Dynamic Watchlist (Broad Scan candidates)</p>
        </div>
        <div class="actions">
          <div id="statusPill" class="badge-strat" style="margin-right:10px">Syncing...</div>
          <div style="display:flex; gap:8px; margin-right:20px; border-right:1px solid var(--stroke); padding-right:20px;">
            <button class="btn-load" id="btnRefreshList" title="Re-run strategies on existing data">‚Üª Refresh</button>
            <button class="btn-load" id="btnRecalc" title="Recalculate indicators (Slow)" style="border-color:var(--stroke); color:var(--muted)">‚ö† Recalc</button>
          </div>
          <input class="ticker-input" id="manualTicker" placeholder="Ticker (e.g. AAPL)">
          <button class="btn-load" id="btnGo">Go</button>
        </div>
      </div>

      <div class="header-row" style="margin-top: 20px; border-bottom: none; margin-bottom: 0; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="font-family:'Space Grotesk', sans-serif; font-size: 20px; color: var(--accent); margin:0;">üíº Portfolio Holdings</h2>
        <div style="display:flex; gap:10px;">
            <button class="btn-load" id="btnShowAddTx" style="border-color:var(--accent); color:var(--accent)">+ Add Transaction</button>
            <button class="btn-load" id="btnShowHistory">üìú History</button>
        </div>
      </div>

      <!-- Add Transaction Form (Hidden by default) -->
      <div id="addTxForm" style="display:none; margin-top:15px; padding:20px; background:var(--card); border:1px solid var(--accent); border-radius:12px;">
        <h3 style="margin-top:0; font-size:16px; color:var(--accent);">New Transaction</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:15px;">
            <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Ticker</label>
                <input class="ticker-input" id="txTicker" placeholder="AAPL" style="width:100%">
            </div>
            <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Side</label>
                <select class="ticker-input" id="txSide" style="width:100%; height:37px;">
                    <option value="BUY">BUY</option>
                    <option value="SELL">SELL</option>
                    <option value="DIVIDEND">DIVIDEND</option>
                    <option value="SPLIT">SPLIT</option>
                </select>
            </div>
            <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Quantity</label>
                <input type="number" step="any" class="ticker-input" id="txQty" placeholder="0.0" style="width:100%">
            </div>
            <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Price</label>
                <input type="number" step="any" class="ticker-input" id="txPrice" placeholder="0.0" style="width:100%">
            </div>
            <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Currency</label>
                <select class="ticker-input" id="txCurr" style="width:100%; height:37px;">
                    <option value="MXN">MXN</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Date (Optional)</label>
                <input type="datetime-local" class="ticker-input" id="txTime" style="width:100%; height:37px;">
            </div>
        </div>
        <div style="margin-top:15px; display:flex; gap:15px; align-items:flex-end;">
            <div style="flex-grow:1">
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:5px;">Notes (Optional)</label>
                <input class="ticker-input" id="txNotes" placeholder="Reason for trade..." style="width:100%">
            </div>
            <button class="btn-load" id="btnSaveTx" style="background:var(--accent); color:var(--bg-1); font-weight:700; border:none; height:37px; padding:0 30px;">Save Transaction</button>
            <button class="btn-load" id="btnCancelTx" style="height:37px;">Cancel</button>
        </div>
      </div>

      <!-- History Modal (Simple Overlay) -->
      <div id="historyOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; padding:40px;">
        <div style="max-width:900px; margin:0 auto; background:var(--bg-2); border:1px solid var(--stroke); border-radius:15px; height:80vh; display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding:20px; border-bottom:1px solid var(--stroke); display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; font-family:'Space Grotesk';">Transaction History</h2>
                <button class="btn-load" id="btnCloseHistory">Close</button>
            </div>
            <div id="historyContent" style="flex-grow:1; overflow-y:auto; padding:20px;">
                <!-- Table goes here -->
            </div>
        </div>
      </div>

      <div id="portfolioContainer">
        <div class="loading">Loading positions...</div>
      </div>

      <div class="header-row" style="margin-top: 40px; border-bottom: none; margin-bottom: 0;">
        <h2 style="font-family:'Space Grotesk', sans-serif; font-size: 20px; color: var(--accent);">üîç Market Screener</h2>
      </div>
      <div id="tableContainer">
        <div class="loading">Fetching candidates...</div>
      </div>

      <div class="glossary">
        <div class="glossary-item">
            <h4>üü¢ BUY_BOUNCE</h4>
            <p>Panic Bounce: Gap o ca√≠da > 6%, RSI bajo y volumen decente. Buscando el rebote del gato muerto o reversi√≥n.</p>
        </div>
        <div class="glossary-item">
            <h4>üü° BUY_TREND</h4>
            <p>Trend Following: ADX > 25 (fuerza), EMA50 > 200 (tendencia alcista) y MACDh positivo. Montando la ola.</p>
        </div>
        <div class="glossary-item">
            <h4>üî¥ SELL_STRENGTH</h4>
            <p>Euphoria Exit: RSI > 70. Solo para holdings. Buscando tomar ganancias cuando todos los dem√°s est√°n euf√≥ricos.</p>
        </div>
        <div class="glossary-item">
            <h4>‚ö™ WATCHLIST</h4>
            <p>Tus favoritos manuales. Sin se√±al activa, pero bajo vigilancia constante.</p>
        </div>
      </div>
    </div>

    <script>
      const tableContainer = document.getElementById("tableContainer");
      const statusPill = document.getElementById("statusPill");
      const manualTicker = document.getElementById("manualTicker");
      const btnGo = document.getElementById("btnGo");
      const btnRefreshList = document.getElementById("btnRefreshList");
      const btnRecalc = document.getElementById("btnRecalc");

      // UI Portfolio Controls
      const btnShowAddTx = document.getElementById("btnShowAddTx");
      const btnShowHistory = document.getElementById("btnShowHistory");
      const addTxForm = document.getElementById("addTxForm");
      const btnCancelTx = document.getElementById("btnCancelTx");
      const btnSaveTx = document.getElementById("btnSaveTx");
      const historyOverlay = document.getElementById("historyOverlay");
      const btnCloseHistory = document.getElementById("btnCloseHistory");
      const historyContent = document.getElementById("historyContent");

      // Form Fields
      const txTicker = document.getElementById("txTicker");
      const txSide = document.getElementById("txSide");
      const txQty = document.getElementById("txQty");
      const txPrice = document.getElementById("txPrice");
      const txCurr = document.getElementById("txCurr");
      const txTime = document.getElementById("txTime");
      const txNotes = document.getElementById("txNotes");

      btnShowAddTx.onclick = () => { 
          addTxForm.style.display = 'block'; 
          txTicker.focus();
          // Pre-llenar con la fecha/hora actual local para conveniencia
          const now = new Date();
          now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
          txTime.value = now.toISOString().slice(0,16);
      };
      btnCancelTx.onclick = () => { addTxForm.style.display = 'none'; };
      
      btnSaveTx.onclick = async () => {
          let timestamp = txTime.value;
          if (timestamp) {
              // Convertir T de ISO a espacio para DuckDB: YYYY-MM-DD HH:MM
              timestamp = timestamp.replace('T', ' ');
          }

          const payload = {
              ticker: txTicker.value.trim().toUpperCase(),
              side: txSide.value,
              qty: parseFloat(txQty.value),
              price: parseFloat(txPrice.value),
              currency: txCurr.value,
              timestamp: timestamp || null,
              notes: txNotes.value.trim() || null
          };

          if(!payload.ticker || isNaN(payload.qty) || isNaN(payload.price)) {
              alert("Please fill required fields (Ticker, Qty, Price)");
              return;
          }

          try {
              const resp = await fetch('/api/v2/portfolio/transaction', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify(payload)
              });
              if(!resp.ok) throw new Error("API Error");
              
              addTxForm.style.display = 'none';
              // Reset fields
              txTicker.value = ''; txQty.value = ''; txPrice.value = ''; txNotes.value = '';
              
              loadDashboard(); // Reload everything
          } catch(e) {
              alert("Error saving transaction: " + e.message);
          }
      };

      btnShowHistory.onclick = async () => {
          historyOverlay.style.display = 'block';
          loadHistory();
      };
      
      btnCloseHistory.onclick = () => { historyOverlay.style.display = 'none'; };

      async function loadHistory() {
          historyContent.innerHTML = '<div class="loading">Loading history...</div>';
          try {
              const resp = await fetch('/api/v2/portfolio/transactions');
              const txs = await resp.json();
              
              if(!txs.length) {
                  historyContent.innerHTML = '<div style="padding:40px; text-align:center; color:var(--muted)">No transactions found.</div>';
                  return;
              }

              let html = `<table style="font-size:12px;">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Ticker</th>
                    <th>Side</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Notes</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>`;
              
              txs.forEach(tx => {
                  const dateStr = new Date(tx.timestamp).toLocaleString();
                  const sideCls = tx.side === 'BUY' ? 'val-up' : (tx.side === 'SELL' ? 'val-down' : 'val-neutral');
                  html += `
                    <tr>
                      <td class="meta-cell">${dateStr}</td>
                      <td style="font-weight:700; color:var(--accent)">${tx.ticker}</td>
                      <td class="${sideCls}" style="font-weight:700">${tx.side}</td>
                      <td>${tx.qty}</td>
                      <td>${tx.currency === 'USD' ? '$' : ''}${tx.price.toFixed(2)} ${tx.currency}</td>
                      <td class="meta-cell">${tx.notes || ''}</td>
                      <td><button onclick="deleteTx(${tx.id})" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:16px;" title="Delete">üóë</button></td>
                    </tr>
                  `;
              });
              html += `</tbody></table>`;
              historyContent.innerHTML = html;
          } catch(e) {
              historyContent.innerHTML = `<div class="val-down">Error: ${e.message}</div>`;
          }
      }

      window.deleteTx = async (id) => {
          if(!confirm(`Delete transaction #${id}?`)) return;
          try {
              const resp = await fetch(`/api/v2/portfolio/transaction/${id}`, {method: 'DELETE'});
              if(!resp.ok) throw new Error("API Error");
              loadHistory();
              loadPortfolio(); // Update the main view too
          } catch(e) {
              alert("Error deleting: " + e.message);
          }
      };

      let currentData = [];
      let currentPortfolio = [];
      let sortCol = 'strategies'; // Default sort by signal
      let sortAsc = false; // Descending (signals first)

      async function loadDashboard() {
          loadScreener();
          loadPortfolio();
      }

      async function loadPortfolio(){
        try {
          const resp = await fetch('/api/v2/portfolio');
          if (resp.status === 500) throw new Error("Server Syncing...");
          if (!resp.ok) throw new Error("API Error");
          const data = await resp.json();
          currentPortfolio = data.items || [];
          renderPortfolio(data.totals);
        } catch (err) {
          console.warn(err);
          // Don't wipe the table on transient errors, just show a pill or small error
          if(currentPortfolio.length === 0) {
             portfolioContainer.innerHTML = `<div class="loading">${err.message}</div>`;
          }
        }
      }

      function renderPortfolio(totals){
        if(!currentPortfolio.length) {
            portfolioContainer.innerHTML = '<div class="loading" style="padding: 20px;">No open positions found in trade log.</div>';
            return;
        }
        
        // Helper para filas de items
        const renderRows = (items) => {
            return items.map(item => {
                const qty = item.qty || 0;
                const avg = item.avg_buy_price || 0;
                const curr = item.current_price || 0;
                const invested = item.invested || 0;
                const pnlVal = item.pnl_val || 0;
                const pnlPct = item.pnl_pct || 0;
                const pnlClass = pnlPct >= 0 ? 'val-up' : 'val-down';
                
                let badgesHtml = '';
                if (item.strategies) {
                    item.strategies.split(', ').forEach(s => {
                        let color = 'var(--muted)';
                        if(s.includes('BUY')) color = 'var(--accent)';
                        if(s.includes('SELL')) color = 'var(--danger)';
                        badgesHtml += `<span class="badge-strat" style="background:rgba(255,255,255,0.05); border-color:${color}; color:${color}">${s}</span>`;
                    });
                }

                return `
                <tr onclick="window.location.href='triple_screen.html?ticker=${item.ticker}'">
                  <td class="ticker-cell">${item.ticker} <span class="meta-cell" style="font-weight:400; font-size:11px">${item.name || ''}</span></td>
                  <td>${badgesHtml}</td>
                  <td>${qty}</td>
                  <td class="meta-cell">$${avg.toFixed(2)}</td>
                  <td style="font-weight:600">$${curr.toFixed(2)}</td>
                  <td>$${invested.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                  <td class="${pnlClass}" style="font-weight:700">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</td>
                  <td class="${pnlClass}">${pnlVal >= 0 ? '+' : ''}$${pnlVal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                </tr>`;
            }).join('');
        };

        // Separar por divisa
        const mxnItems = currentPortfolio.filter(i => i.currency === 'MXN');
        const usdItems = currentPortfolio.filter(i => i.currency === 'USD');

        let html = `<table>
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Signals</th>
                <th>Qty</th>
                <th>Avg Price</th>
                <th>Current</th>
                <th>Invested</th>
                <th>P&L %</th>
                <th>P&L $</th>
              </tr>
            </thead>
            <tbody>`;

        if (mxnItems.length) {
            html += `<tr style="background:rgba(255,255,255,0.02)"><td colspan="8" style="font-weight:bold; color:var(--muted); padding-top:15px">üá≤üáΩ MXN HOLDINGS</td></tr>`;
            html += renderRows(mxnItems);
            // Subtotal MXN
            if (totals && totals.mxn) {
                 const t = totals.mxn;
                 const cls = t.pnl >= 0 ? 'val-up' : 'val-down';
                 html += `<tr style="border-top:1px solid var(--stroke); font-weight:600; font-size:13px">
                    <td colspan="5" style="text-align:right">Subtotal MXN</td>
                    <td>$${t.invested.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td></td>
                    <td class="${cls}">$${t.pnl.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                 </tr>`;
            }
        }

        if (usdItems.length) {
            html += `<tr style="background:rgba(255,255,255,0.02)"><td colspan="8" style="font-weight:bold; color:var(--muted); padding-top:15px">üá∫üá∏ USD HOLDINGS</td></tr>`;
            html += renderRows(usdItems);
            // Subtotal USD
            if (totals && totals.usd) {
                 const t = totals.usd;
                 const cls = t.pnl >= 0 ? 'val-up' : 'val-down';
                 html += `<tr style="border-top:1px solid var(--stroke); font-weight:600; font-size:13px">
                    <td colspan="5" style="text-align:right">Subtotal USD</td>
                    <td>$${t.invested.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                    <td></td>
                    <td class="${cls}">$${t.pnl.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                 </tr>`;
            }
        }

        // GRAN TOTAL
        if (totals && totals.grand_total_mxn) {
             const g = totals.grand_total_mxn;
             const cls = g.pnl >= 0 ? 'val-up' : 'val-down';
             const fx = g.fx_rate || 20;
             html += `
            <tr style="border-top: 3px solid var(--stroke); background: rgba(255,255,255,0.05); font-weight: 700; height: 50px;">
                <td colspan="5" style="text-align: right; padding-right: 20px;">
                    TOTAL PORTFOLIO (EST. MXN) <span style="font-weight:400; font-size:11px; color:var(--muted)">FX: $${fx.toFixed(2)}</span>
                </td>
                <td>$${g.invested.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                <td class="${cls}">${g.pnl_pct >= 0 ? '+' : ''}${g.pnl_pct.toFixed(2)}%</td>
                <td class="${cls}">${g.pnl >= 0 ? '+' : ''}$${g.pnl.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            </tr>
            `;
        }
        
        html += `</tbody></table>`;
        portfolioContainer.innerHTML = html;
      }

      btnGo.onclick = () => {
        const t = manualTicker.value.trim().toUpperCase();
        if (t) window.location.href = `triple_screen.html?ticker=${t}`;
      };
      manualTicker.onkeydown = (e) => { if (e.key === 'Enter') btnGo.click(); };

      btnRefreshList.onclick = async () => {
        if(confirm("Refresh dynamic watchlist from existing DB data?")) {
            statusPill.textContent = "Running...";
            try {
                await fetch('/api/v2/system/refresh-watchlist', {method:'POST'});
                setTimeout(loadScreener, 2000); 
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      btnRecalc.onclick = async () => {
        if(confirm("‚ö† WARNING: This will recalculate indicators for ALL tickers. It may take minutes.\n\nContinue?")) {
            statusPill.textContent = "Recalculating...";
            try {
                await fetch('/api/v2/system/recalc-indicators', {method:'POST'});
                alert("Recalculation started in background. Check logs or refresh later.");
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      async function loadScreener(){
        try {
          const resp = await fetch('/api/v2/screener');
          if (!resp.ok) throw new Error("API Error");
          currentData = await resp.json();
          renderScreener();
          statusPill.textContent = `Active: ${currentData.length}`;
        } catch (err) {
          tableContainer.innerHTML = `<div class="loading">Error connecting to API: ${err.message}</div>`;
          statusPill.textContent = "Offline";
        }
      }

      function sortData(col) {
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = false; }
        renderScreener();
      }

      function renderScreener(){
        // Cambiamos el criterio de ordenamiento por defecto a 'strategies' descendente 
        // para que los que tienen se√±ales salgan primero
        const items = [...currentData].sort((a, b) => {
            let valA = a[sortCol];
            let valB = b[sortCol];
            // Manejo de nulos para sorting
            if (valA == null) valA = '';
            if (valB == null) valB = '';
            
            if (valA < valB) return sortAsc ? -1 : 1;
            if (valA > valB) return sortAsc ? 1 : -1;
            return 0;
        });

        if(!items.length) {
            tableContainer.innerHTML = '<div class="loading">No candidates found.</div>';
            return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th class="sortable" onclick="sortData('ticker')">Ticker</th>
                <th class="sortable" onclick="sortData('strategies')">Signal / Tags</th>
                <th class="sortable" onclick="sortData('close')">Price</th>
                <th class="sortable" onclick="sortData('chg_1d')">1D %</th>
                <th class="sortable" onclick="sortData('chg_2d')">2D %</th>
                <th class="sortable" onclick="sortData('chg_3d')">3D %</th>
                <th class="sortable" onclick="sortData('chg_fri')">vs Fri</th>
                <th class="sortable" onclick="sortData('rsi')">RSI</th>
                <th class="sortable hide-mobile" onclick="sortData('adx')">ADX</th>
                <th class="sortable hide-mobile" onclick="sortData('vol_k')">Vol K</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        items.forEach(item => {
          const getChgCls = (v) => (v >= 0 ? 'val-up' : 'val-down');
          const fmtChg = (v) => v != null ? `${v >= 0 ? '+' : ''}${v.toFixed(1)}%` : '‚Äî';

          const rsiVal = item.rsi != null ? item.rsi.toFixed(1) : '‚Äî';
          const adxVal = item.adx != null ? item.adx.toFixed(1) : '‚Äî';
          const volVal = item.vol_k != null ? `x${item.vol_k.toFixed(2)}` : '‚Äî';
          const priceVal = item.close != null ? item.close.toFixed(2) : '‚Äî';
          const holdingClass = item.is_holding ? 'is-holding' : '';
          
          // Construir Badges
          let badgesHtml = '';
          if (item.is_holding) badgesHtml += `<span class="badge-strat" style="border-color:var(--accent); color:var(--accent)">üíº HOLDING</span>`;
          if (item.is_favourite) badgesHtml += `<span class="badge-strat" style="border-color:var(--accent-2); color:var(--accent-2)">‚≠ê FAV</span>`;
          
          if (item.strategies) {
              const strats = item.strategies.split(', ');
              strats.forEach(s => {
                  let color = 'var(--muted)';
                  if(s.includes('BUY')) color = 'var(--accent)';
                  if(s.includes('SELL')) color = 'var(--danger)';
                  badgesHtml += `<span class="badge-strat" style="background:rgba(255,255,255,0.05); border-color:${color}; color:${color}">${s}</span>`;
              });
          }
          if (!badgesHtml) badgesHtml = `<span class="badge-strat">WATCHLIST</span>`;
          
          html += `
            <tr class="${holdingClass}" onclick="window.location.href='triple_screen.html?ticker=${item.ticker}'">
              <td class="ticker-cell">${item.ticker}</td>
              <td>
                <div style="display:flex; flex-wrap:wrap; gap:4px; align-items:center">
                    ${badgesHtml}
                    <span class="meta-cell" style="margin-left:8px; font-size:11px">${item.name || ''}</span>
                </div>
              </td>
              <td style="font-weight:600">${priceVal}</td>
              <td class="${getChgCls(item.chg_1d)}">${fmtChg(item.chg_1d)}</td>
              <td class="${getChgCls(item.chg_2d)}">${fmtChg(item.chg_2d)}</td>
              <td class="${getChgCls(item.chg_3d)}">${fmtChg(item.chg_3d)}</td>
              <td class="${getChgCls(item.chg_fri)}" style="border-left:1px solid var(--stroke)">${fmtChg(item.chg_fri)}</td>
              <td class="${getRsiClass(item.rsi)}">${rsiVal}</td>
              <td class="hide-mobile ${item.adx > 25 ? 'val-up' : 'val-neutral'}">${adxVal}</td>
              <td class="hide-mobile ${item.vol_k > 1.5 ? 'val-up' : 'val-neutral'}">${volVal}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table>`;
        tableContainer.innerHTML = html;
      }


      function getRsiClass(val){
        if (!val) return '';
        if (val >= 70) return 'val-down';
        if (val <= 30) return 'val-up';
        return '';
      }

      loadDashboard();
      // Refresh cada 5 minutos
      setInterval(loadDashboard, 300000);
    </script>
  </body>
</html>