<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Market Screener V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg-1:#0b1220;
        --bg-2:#0f1b2b;
        --ink:#e6edf5;
        --muted:#9fb2c7;
        --accent:#3ddc97;
        --accent-2:#ffb454;
        --danger:#ff6b6b;
        --card:#0f1e2f;
        --stroke:#1c2b3a;
        --panel:rgba(255,255,255,0.03);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family:"IBM Plex Sans",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
        color:var(--ink);
        background:
          radial-gradient(900px 420px at 10% -10%, #1c3a52 0%, rgba(28,58,82,0) 60%),
          radial-gradient(700px 420px at 90% 0%, #17303f 0%, rgba(23,48,63,0) 60%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height:100vh;
      }
      .wrap{
        max-width:1200px;
        margin:0 auto;
        padding:40px 24px 80px;
      }
      .hero{
        margin-bottom:40px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .actions{
        display:flex;
        gap:10px;
        align-items:center;
      }
      .ticker-input{
        padding:8px 12px;
        border-radius:10px;
        border:1px solid var(--stroke);
        background:#0b1724;
        color:var(--ink);
        font-size:14px;
        width: 120px;
      }
      .btn-load{
        color:var(--ink);
        text-decoration:none;
        border:1px solid var(--stroke);
        padding:8px 14px;
        border-radius:10px;
        font-size:14px;
        background:rgba(255,255,255,0.03);
        cursor: pointer;
      }
      .btn-load:hover{ background: rgba(255,255,255,0.08); }
      .title{
        font-family:"Space Grotesk",sans-serif;
        font-size:38px;
        font-weight:700;
        margin:0;
      }
      .subtitle{
        color:var(--muted);
        margin-top:8px;
        font-size:16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
      }
      th {
        text-align: left;
        padding: 12px 16px;
        color: var(--muted);
        font-weight: 600;
        border-bottom: 1px solid var(--stroke);
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
      }
      td {
        padding: 10px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.03);
        vertical-align: middle;
      }
      tr:hover td {
        background: rgba(255,255,255,0.02);
      }
      tr.is-holding {
        background: rgba(61, 220, 151, 0.03);
      }
      tr.is-holding td:first-child {
        border-left: 3px solid var(--accent);
      }
      th.sortable {
        cursor: pointer;
        user-select: none;
      }
      th.sortable:hover {
        color: var(--accent);
      }
      th.sortable:after {
        content: ' ‚Üï';
        font-size: 9px;
        opacity: 0.5;
      }
      .ticker-cell {
        font-family: "Space Grotesk", sans-serif;
        font-weight: 700;
        color: var(--accent);
        font-size: 15px;
      }
      .glossary {
        margin-top: 40px;
        padding: 20px;
        background: var(--card);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .glossary-item h4 {
        margin: 0 0 8px;
        font-size: 12px;
        color: var(--accent);
        text-transform: uppercase;
      }
      .glossary-item p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }
      .val-up{ color:var(--accent); }
      .name-cell {
        color: var(--ink);
        font-weight: 500;
      }
      .meta-cell {
        font-size: 12px;
        color: var(--muted);
      }
      .row-link {
        text-decoration: none;
        color: inherit;
        display: contents; /* Trick to make <a> wrap tr behavior? No, better click handler or <a> inside td */
      }
      /* Clickable row technique */
      tr { cursor: pointer; }

      .val-up{ color:var(--accent); }
      .val-down{ color:var(--danger); }
      .val-neutral{ color:var(--muted); }

      .badge-strat{
        padding:3px 8px;
        border-radius:4px;
        font-size:10px;
        font-weight:700;
        background:rgba(255,255,255,0.05);
        border:1px solid var(--stroke);
        display:inline-block;
        margin-right: 6px;
      }
      
      @media (max-width: 700px) {
        .hide-mobile { display: none; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1 class="title">Market Screener</h1>
          <p class="subtitle">Dynamic Watchlist (Broad Scan candidates)</p>
        </div>
        <div class="actions">
          <div id="statusPill" class="badge-strat" style="margin-right:10px">Syncing...</div>
          <div style="display:flex; gap:8px; margin-right:20px; border-right:1px solid var(--stroke); padding-right:20px;">
            <button class="btn-load" id="btnRefreshList" title="Re-run strategies on existing data">‚Üª Refresh</button>
            <button class="btn-load" id="btnRecalc" title="Recalculate indicators (Slow)" style="border-color:var(--stroke); color:var(--muted)">‚ö† Recalc</button>
          </div>
          <input class="ticker-input" id="manualTicker" placeholder="Ticker (e.g. AAPL)">
          <button class="btn-load" id="btnGo">Go</button>
        </div>
      </div>

      <div class="header-row" style="margin-top: 20px; border-bottom: none; margin-bottom: 0;">
        <h2 style="font-family:'Space Grotesk', sans-serif; font-size: 20px; color: var(--accent);">üíº Portfolio Holdings</h2>
      </div>
      <div id="portfolioContainer">
        <div class="loading">Loading positions...</div>
      </div>

      <div class="header-row" style="margin-top: 40px; border-bottom: none; margin-bottom: 0;">
        <h2 style="font-family:'Space Grotesk', sans-serif; font-size: 20px; color: var(--accent);">üîç Market Screener</h2>
      </div>
      <div id="tableContainer">
        <div class="loading">Fetching candidates...</div>
      </div>

      <div class="glossary">
        <div class="glossary-item">
            <h4>üü¢ BUY_BOUNCE</h4>
            <p>Panic Bounce: Gap o ca√≠da > 6%, RSI bajo y volumen decente. Buscando el rebote del gato muerto o reversi√≥n.</p>
        </div>
        <div class="glossary-item">
            <h4>üü° BUY_TREND</h4>
            <p>Trend Following: ADX > 25 (fuerza), EMA50 > 200 (tendencia alcista) y MACDh positivo. Montando la ola.</p>
        </div>
        <div class="glossary-item">
            <h4>üî¥ SELL_STRENGTH</h4>
            <p>Euphoria Exit: RSI > 70. Solo para holdings. Buscando tomar ganancias cuando todos los dem√°s est√°n euf√≥ricos.</p>
        </div>
        <div class="glossary-item">
            <h4>‚ö™ WATCHLIST</h4>
            <p>Tus favoritos manuales. Sin se√±al activa, pero bajo vigilancia constante.</p>
        </div>
      </div>
    </div>

    <script>
      const tableContainer = document.getElementById("tableContainer");
      const statusPill = document.getElementById("statusPill");
      const manualTicker = document.getElementById("manualTicker");
      const btnGo = document.getElementById("btnGo");
      const btnRefreshList = document.getElementById("btnRefreshList");
      const btnRecalc = document.getElementById("btnRecalc");

      let currentData = [];
      let currentPortfolio = [];
      let sortCol = 'strategies'; // Default sort by signal
      let sortAsc = false; // Descending (signals first)

      async function loadDashboard() {
          loadScreener();
          loadPortfolio();
      }

      async function loadPortfolio(){
        try {
          const resp = await fetch('/api/v2/portfolio');
          if (!resp.ok) throw new Error("API Error");
          currentPortfolio = await resp.json();
          renderPortfolio();
        } catch (err) {
          portfolioContainer.innerHTML = `<div class="loading">Error loading portfolio: ${err.message}</div>`;
        }
      }

      function renderPortfolio(){
        if(!currentPortfolio.length) {
            portfolioContainer.innerHTML = '<div class="loading" style="padding: 20px;">No open positions found in trade log.</div>';
            return;
        }
        
        let totalInvested = 0;
        let totalCurrent = 0;
        let totalPnL = 0;

        let html = `
          <table>
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Signals</th>
                <th>Qty</th>
                <th>Avg Price</th>
                <th>Current</th>
                <th>Invested</th>
                <th>P&L %</th>
                <th>P&L $</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        currentPortfolio.forEach(item => {
          const qty = item.qty || 0;
          const avg = item.avg_buy_price || 0;
          const curr = item.current_price || 0;
          const invested = qty * avg;
          const currentVal = qty * curr;
          const pnlVal = currentVal - invested;
          const pnlPct = invested > 0 ? (pnlVal / invested * 100) : 0;
          
          totalInvested += invested;
          totalCurrent += currentVal;
          totalPnL += pnlVal;

          const pnlClass = pnlPct >= 0 ? 'val-up' : 'val-down';

          // Construir Badges
          let badgesHtml = '';
          if (item.strategies) {
              item.strategies.split(', ').forEach(s => {
                  let color = 'var(--muted)';
                  if(s.includes('BUY')) color = 'var(--accent)';
                  if(s.includes('SELL')) color = 'var(--danger)';
                  badgesHtml += `<span class="badge-strat" style="background:rgba(255,255,255,0.05); border-color:${color}; color:${color}">${s}</span>`;
              });
          }
          
          html += `
            <tr onclick="window.location.href='triple_screen.html?ticker=${item.ticker}'">
              <td class="ticker-cell">${item.ticker} <span class="meta-cell" style="font-weight:400; font-size:11px">${item.name || ''}</span></td>
              <td>${badgesHtml}</td>
              <td>${qty}</td>
              <td class="meta-cell">$${avg.toFixed(2)}</td>
              <td style="font-weight:600">$${curr.toFixed(2)}</td>
              <td>$${invested.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
              <td class="${pnlClass}" style="font-weight:700">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</td>
              <td class="${pnlClass}">${pnlVal >= 0 ? '+' : ''}$${pnlVal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            </tr>
          `;
        });
        
        // Footer con Totales
        const totalClass = totalPnL >= 0 ? 'val-up' : 'val-down';
        const totalPct = totalInvested > 0 ? (totalPnL / totalInvested * 100) : 0;

        html += `
            <tr style="border-top: 2px solid var(--stroke); background: rgba(255,255,255,0.05); font-weight: 700;">
                <td colspan="5" style="text-align: right; padding-right: 20px;">TOTAL PORTFOLIO</td>
                <td>$${totalInvested.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td class="${totalClass}">${totalPct >= 0 ? '+' : ''}${totalPct.toFixed(2)}%</td>
                <td class="${totalClass}">${totalPnL >= 0 ? '+' : ''}$${totalPnL.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            </tr>
        `;
        
        html += `</tbody></table>`;
        portfolioContainer.innerHTML = html;
      }

      btnGo.onclick = () => {
        const t = manualTicker.value.trim().toUpperCase();
        if (t) window.location.href = `triple_screen.html?ticker=${t}`;
      };
      manualTicker.onkeydown = (e) => { if (e.key === 'Enter') btnGo.click(); };

      btnRefreshList.onclick = async () => {
        if(confirm("Refresh dynamic watchlist from existing DB data?")) {
            statusPill.textContent = "Running...";
            try {
                await fetch('/api/v2/system/refresh-watchlist', {method:'POST'});
                setTimeout(loadScreener, 2000); 
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      btnRecalc.onclick = async () => {
        if(confirm("‚ö† WARNING: This will recalculate indicators for ALL tickers. It may take minutes.\n\nContinue?")) {
            statusPill.textContent = "Recalculating...";
            try {
                await fetch('/api/v2/system/recalc-indicators', {method:'POST'});
                alert("Recalculation started in background. Check logs or refresh later.");
            } catch(e) { alert("Error: " + e.message); }
        }
      };

      async function loadScreener(){
        try {
          const resp = await fetch('/api/v2/screener');
          if (!resp.ok) throw new Error("API Error");
          currentData = await resp.json();
          renderScreener();
          statusPill.textContent = `Active: ${currentData.length}`;
        } catch (err) {
          tableContainer.innerHTML = `<div class="loading">Error connecting to API: ${err.message}</div>`;
          statusPill.textContent = "Offline";
        }
      }

      function sortData(col) {
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = false; }
        renderScreener();
      }

      function renderScreener(){
        // Cambiamos el criterio de ordenamiento por defecto a 'strategies' descendente 
        // para que los que tienen se√±ales salgan primero
        const items = [...currentData].sort((a, b) => {
            let valA = a[sortCol];
            let valB = b[sortCol];
            // Manejo de nulos para sorting
            if (valA == null) valA = '';
            if (valB == null) valB = '';
            
            if (valA < valB) return sortAsc ? -1 : 1;
            if (valA > valB) return sortAsc ? 1 : -1;
            return 0;
        });

        if(!items.length) {
            tableContainer.innerHTML = '<div class="loading">No candidates found.</div>';
            return;
        }
        
        let html = `
          <table>
            <thead>
              <tr>
                <th class="sortable" onclick="sortData('ticker')">Ticker</th>
                <th class="sortable" onclick="sortData('strategies')">Signal / Tags</th>
                <th class="sortable" onclick="sortData('close')">Price</th>
                <th class="sortable" onclick="sortData('chg_pct')">Chg (1D)</th>
                <th class="sortable" onclick="sortData('rsi')">RSI</th>
                <th class="sortable hide-mobile" onclick="sortData('adx')">ADX</th>
                <th class="sortable hide-mobile" onclick="sortData('vol_k')">Vol K</th>
                <th class="sortable hide-mobile" onclick="sortData('added_at')">Added</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        items.forEach(item => {
          const chg = item.chg_pct || 0;
          const chgClass = chg >= 0 ? 'val-up' : 'val-down';
          const rsiVal = item.rsi != null ? item.rsi.toFixed(1) : '‚Äî';
          const adxVal = item.adx != null ? item.adx.toFixed(1) : '‚Äî';
          const volVal = item.vol_k != null ? `x${item.vol_k.toFixed(2)}` : '‚Äî';
          const priceVal = item.close != null ? item.close.toFixed(2) : '‚Äî';
          const dateAdded = item.added_at ? item.added_at.split(' ')[0] : '';
          const holdingClass = item.is_holding ? 'is-holding' : '';
          
          // Construir Badges
          let badgesHtml = '';
          
          // 1. Tags de Pertenencia
          if (item.is_holding) badgesHtml += `<span class="badge-strat" style="border-color:var(--accent); color:var(--accent)">üíº HOLDING</span>`;
          if (item.is_favourite) badgesHtml += `<span class="badge-strat" style="border-color:var(--accent-2); color:var(--accent-2)">‚≠ê FAV</span>`;
          
          // 2. Estrategias (Split por coma)
          if (item.strategies) {
              const strats = item.strategies.split(', ');
              strats.forEach(s => {
                  let color = 'var(--muted)';
                  if(s.includes('BUY')) color = 'var(--accent)';
                  if(s.includes('SELL')) color = 'var(--danger)';
                  badgesHtml += `<span class="badge-strat" style="background:rgba(255,255,255,0.05); border-color:${color}; color:${color}">${s}</span>`;
              });
          }

          // Si no tiene nada, poner tag de Watchlist gen√©rico
          if (!badgesHtml) badgesHtml = `<span class="badge-strat">WATCHLIST</span>`;
          
          html += `
            <tr class="${holdingClass}" onclick="window.location.href='triple_screen.html?ticker=${item.ticker}'">
              <td class="ticker-cell">${item.ticker}</td>
              <td>
                <div style="display:flex; flex-wrap:wrap; gap:4px; align-items:center">
                    ${badgesHtml}
                    <span class="meta-cell" style="margin-left:8px">${item.name || ''}</span>
                </div>
              </td>
              <td style="font-weight:600">${priceVal}</td>
              <td class="${chgClass}">${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%</td>
              <td class="${getRsiClass(item.rsi)}">${rsiVal}</td>
              <td class="hide-mobile ${item.adx > 25 ? 'val-up' : 'val-neutral'}">${adxVal}</td>
              <td class="hide-mobile ${item.vol_k > 1.5 ? 'val-up' : 'val-neutral'}">${volVal}</td>
              <td class="meta-cell hide-mobile">${dateAdded}</td>
            </tr>
          `;
        });
        
        html += `</tbody></table>`;
        tableContainer.innerHTML = html;
      }


      function getRsiClass(val){
        if (!val) return '';
        if (val >= 70) return 'val-down';
        if (val <= 30) return 'val-up';
        return '';
      }

      loadDashboard();
      // Refresh cada 5 minutos
      setInterval(loadDashboard, 300000);
    </script>
  </body>
</html>