# MarketDashboard AI Context

Este archivo define el contexto, arquitectura y reglas para agentes de IA que trabajen en este repositorio.

## 游 Contexto del Proyecto
MarketDashboard es un sistema modular de trading (Screener + Alertas) desarrollado en Python.
- **Desarrollador:** Single coder (el usuario).
- **Entorno de Edici칩n:** PC Local (5800X + RTX5080ti) accesando archivos v칤a NFS.
- **Entorno de Ejecuci칩n:** Docker en TrueNAS Scale.

## 游 Infraestructura y Despliegue
- **CI/CD:** Commit + Push -> Portainer Rebuild.
- **Truco de Rebuild:** Modificar `build_stamp.txt` para forzar `pip install`.
- **Desarrollo Local:** 
  - Usar `DB_PATH_OVERRIDE=data/test_markets.duckdb` para no cargar la DB de 3GB.
  - Ejecutar con `uvicorn svc_v2.api:app --reload` para iterar r치pido.

## 游끵 Arquitectura V2 (The Funnel & Engine)
1.  **Nivel 1 (Broad):** Escaneo diario (1d) del universo completo.
2.  **Nivel 2 (Detailed):** Monitoreo intrad칤a (1h/15m) de TODO el universo (almac칠n de datos completo).
3.  **Alertas:** Batching de notificaciones VIP (Holdings/Watchlist) para reducir ruido.
4.  **Journaling:** Motor FIFO realizado en API que normaliza P&L a MXN usando FX hist칩rico.

## 游듻 Reglas de Base de Datos y API
- **Concurrencia:** La API utiliza conexiones **transitorias** (Context Managers) para evitar conflictos de configuraci칩n (`read_only` vs `write`) con el Daemon.
- **FIFO:** El c치lculo de Cost Basis (`avg_buy_price`) se realiza al vuelo en la API (o v칤a vista robusta) descontando ventas de las compras m치s antiguas.
- **Normalizaci칩n:** Los montos se guardan en su divisa original, pero el Journal convierte a MXN bas치ndose en el precio de `USDMXN=X` del d칤a del cierre.

## 游띠 Reglas de Oro para la IA
1.  **No romper Producci칩n:** El sistema corre 24/7.
2.  **UTC Naive:** La DB guarda en UTC. La API convierte a ISO format con 'Z'.
3.  **JSON Compliance:** Siempre usar `df.astype(object).where(pd.notnull(df), None)` para limpiar NaNs/Infs antes de devolver JSON.
4.  **SQL Estricto:** Usar alias expl칤citos en `VALUES` y `JOINs` para evitar errores de Binder en DuckDB.